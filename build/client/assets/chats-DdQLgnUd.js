import{w}from"./with-props-BITBR5i4.js";import{o as e,a as i}from"./chunk-D4RADZKF-F8gbsHt2.js";import{C as v}from"./global-DqGd4opN.js";import{A as _}from"./ava-C2JHgPho.js";function N({id:o,name:a,last:r,nUnread:c,click:u}){return e.jsxs("div",{className:"chat row",onClick:u,children:[e.jsx(_,{id:o,figureClass:"chat__ava"}),e.jsxs("h3",{className:"chat__name",children:[a,c>0&&e.jsx("p",{className:"chat__unread",children:c}),e.jsx("p",{className:"chat__text",children:r})]})]})}function y({id:o,name:a,body:r}){return e.jsxs("div",{className:"msg",children:[e.jsx(_,{id:o,figureClass:"ava"}),e.jsx("h3",{children:a}),e.jsx("p",{children:r})]})}function b({clickedChatIndex:o,chats:a,setChats:r,msgs:c}){var m;const{curUser:u}=i.useContext(v),[l,p]=i.useState([]),d=i.useRef(null);i.useEffect(()=>{(async()=>{const s=await(await fetch("http://localhost:3000/api/v1/users")).json();p(s)})()},[]);async function f(t){t.preventDefault(),await fetch(`http://localhost:3000/api/v1/users/${u.id}/chats/${a[o.current].id}`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({body:d.current.value})}),d.current.value=""}async function x(t){await fetch(`http://localhost:3000/api/v1/chats/${a[o.current].id}`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:l[t.target.value].id})});const s=window.structuredClone(a);s[o.current].users.push({id:l[t.target.value].id,name:l[t.target.value].name}),r(s)}return e.jsxs("div",{className:"chats__dialog dialog",children:[a[o.current]&&e.jsxs("div",{className:"dialog__header row",children:[e.jsxs("select",{className:"dialog__users",defaultValue:"default",children:[e.jsx("option",{value:"default",disabled:!0,hidden:!0,children:"Список пользователей"}),(m=a[o.current])==null?void 0:m.users.map((t,s)=>e.jsx("option",{disabled:!0,children:t.name},s))]}),a[o.current].name&&e.jsxs("select",{defaultValue:"default",onChange:x,children:[e.jsx("option",{value:"default",disabled:!0,hidden:!0,children:"Добавить пользователя"}),l==null?void 0:l.map((t,s)=>e.jsx("option",{value:s,children:t.name},t.id))]})]}),e.jsx("div",{className:"dialog__msgs",children:c==null?void 0:c.map(t=>e.jsx(y,{id:t.user_id,name:t.name,body:t.body},t.id))}),a[o.current]&&e.jsxs("form",{className:"dialog__form row",onSubmit:f,children:[e.jsx("input",{ref:d,type:"text",placeholder:"Сообщение..."}),e.jsx("button",{type:"submit",className:"btn",children:"Отправить"})]})]})}const g=new WebSocket("ws://localhost:3000/cable"),O=w(function(){const{curUser:a}=i.useContext(v),[r,c]=i.useState([]),[u,l]=i.useState([]),p=i.useRef(null),d=i.useRef(null),f=i.useRef(null);g.onopen=s=>{g.send(JSON.stringify({command:"subscribe",identifier:JSON.stringify({id:a.id,channel:"ChatsChannel"})}))},g.onmessage=s=>{const n=JSON.parse(s.data);console.log(n),typeof n.message=="object"&&n.message.chat_id===r[f.current].id&&l(window.structuredClone(u).concat(n.message))},i.useEffect(()=>{(async()=>{const n=await(await fetch(`http://localhost:3000/api/v1/users/${a.id}/chats`)).json();c(n)})()},[]);function x(s,n){const j=window.structuredClone(r);j[n].n_unread=0,c(j),f.current=n,fetch(`http://localhost:3000/api/v1/chats/${s}`).then(h=>h.json()).then(h=>l(h))}async function m(s){s.preventDefault();const n=new FormData;n.append("name",p.current.value),n.append("users_ids",[]),n.append("images[]",d.current.files[0]);const j=await fetch(`http://localhost:3000/api/v1/users/${a.id}/chats`,{method:"post",body:n});p.current.value="";const h=await j.json();console.log(h),c(window.structuredClone(r).concat(h))}function t(s){return s.name?s.name:s.users[0].id===a.id?s.users[1].name:s.users[0].name}return e.jsxs("section",{className:"chats row",children:[e.jsxs("div",{className:"chats__list",children:[e.jsxs("form",{className:"chats__conf chat",onSubmit:m,children:[e.jsx("input",{className:"input",type:"text",placeholder:"Название",ref:p}),e.jsx("input",{type:"file",accept:"image/*",ref:d}),e.jsx("button",{className:"btn",children:"Создать беседу"})]}),r==null?void 0:r.map((s,n)=>e.jsx(N,{id:1,name:t(s),last:s.last,nUnread:s.n_unread,click:()=>x(s.id,n)},s.id))]}),e.jsx(b,{clickedChatIndex:f,chats:r,setChats:c,msgs:u})]})});export{O as default};
